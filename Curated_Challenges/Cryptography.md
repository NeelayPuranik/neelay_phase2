# 1. All Signs Align

> This challenge provides two files:

1) ```chal.py``` - This seems to be the python program used to encode the flag
2) ```out.txt``` - This seems to be the output produced after running the flag through the script

> Therefore, the solver has to reverse the encryption algorithm applied on the original flag and apply the reversed algorithm on the contents in out.txt

## Solution

- I opened up the ```chal.py``` file in Visual Studio Code and inspected the code
- Initial observations showed that the program defined a large integer named ```p```
- Then, a function called ```get_x()``` is defined in which it first creates a while loop which runs while the following condition is true:

```python
        if pow(x,(p-1)//2,p) == 1:
            break
```

- Where, ```p``` is the earlier defined large integer and ```x``` is a random integer chosen between (2 , p-1)
- The function then returns ```x``` once the loop breaks
- Then, another function called ```get_y()``` is defined which returns:

```python
    return -get_x()%p
```

- Then, another variable ```a``` is also defined as a random integer between (2 , p-1)
- Then, a list named ```out = []``` is declared to presumably store the encoded contents of the flag
- Then, the program creates a for-loop

```python
for b in bin(bytes_to_long(flag))[2:]:
    if b == '0':
        out.append((a*get_x())%p)
    else:
        out.append((a*get_y())%p)
```

- The loop essentially converts the flag from bytes to a long integer and then to a binary string like '0b101010100...' and then removes the '0b' from the binary string
- It then loops through that binary string using the variable ```b```
- If ```b``` is equal to zero then the program outputs ```a * x mod p```
- If not then the program outputs ```a * y mod p```

## Understanding the mathematics behind the program

- ```p``` is a large prime number for taking moduluses
- ```get_x()``` selects a number between (2 , p-1) satisfying a select property
- ```get_y()``` returns the negative modular value of the number obtained from ```get_x()```
- A number ```a``` is also chosen
- Then, the for-loop loops through b (how the value of b is calculated is mentioned above)
- By the nature of the ```get_x()``` we know that ```x``` will always be a quadratic residue of ```p```
- Since ```get_y()``` calculates the negative modulus of ```x``` with respect to ```p```, ```y``` will always be a quadratic non-residue of ```p```
- Moving to the inner contents of the for-loop, if ```b == 0``` then the program will append to the out array ```(a * x) mod p```
- Else, the program will append to the out array ```(a * y) mod p```
- Even though we do not know if ```a``` is a quadratic residue or a non-residue, the following rules always hold:

1) QR * QR = QR
2) QR * QNR = QNR
3) QNR * QR = QNR
4) QNR * QNR = QR

- Therefore, the following two cases are possible:

1) ```a``` is a QR<br>
```a * x``` will be a residue and ```a * (-x)``` will be a non-residue

2) ```a``` is a QNR<br>
```a * x``` will be a non-residue and ```a * (-x)``` will be a residue

- Therefore to solve the program we will first have to figure out which case it is (case 1 or case 2)

## Python script for decoding

- The ```out.txt``` file contains a large integer for each bit of the original flag
- These large integers are either a QR of ```p``` or a QNR of ```p```
- To determine what is the selected number, we must run the Euler's Criterion on each large int:

```python
pow(n, (p−1)//2, p) = 1       # n is a QR
pow(n, (p−1)//2, p) = p−1     # n is a QNR
```

- By running this test on every integer present in the array in ```out.txt```, we can obtain an array containing the QR / QNR labels for each integer
- It would look something like:

```python
[1, p−1, 1, 1, p−1, ...]
```

- But this is not enough to decode the flag since there were two cases for ```a```
- It is either a QR or a QNR, and this choice directly corresponds to what will ```1``` and ```p - 1``` be interpreted as
- Since we do not know the value of ```a```, both the mappings must be tried
- I wrote the following python script to do all the above mentioned tasks:

```python
from Crypto.Util.number import long_to_bytes

p = 9129026491768303016811207218323770273047638648509577266210613478726929333106121387323539916009107476349319902011390210650434835260358014251332047605739279

out = [863894240511287898369544579509196806808637646513127204585985188635677286556884330795324515301874462924536794481890590435492299484323549277060171446825789, 1649688061378141708409747522129353442324449338965386696506015434594708797603250160937654702500764816013664943809723368206277976425196903932085034675319088, 8339844369001071552647224091678779685181034235543365243785029676828082657141598521283767087279433149418538635604594655872452412941678405845166057117126185, 2715358698038285447835318809665139845621504526116461311468658445917263809870215480505503493211788115963287070249738929079081475948912484513156032023011645, 8293419088260592937198760325703561353088791563210525514378501718467025502698120672297034305531602897835300908762205372577743720698003632965358645003639843, 811444680237989185285664287618636180906635525085540759480445081406664996249586731810732835821161784449163494002633995980641601095933111825924279852728290, 3743556717548222445110326997607720752215240940563921757114183323989227249690386399577439965920349437240911728303038048438498225945447677044740941266584372, 8383454561314808361407007102298152213416936716152561390964297542032993586572394060911986945811386431038332038876859287811956815640410165725819191475815730, 7295455348319973887975748008924386003219929672683011218140790501520865250784859383182033520769976107146903160777356171109891120314010296560546104882005836, 27679373269039284411992962222934798219371773152462763590556536035580713862188579005631634449595602248731135498667953656180507079261264902183159170440426, 7669254395935563235721090742923882135979689388432354581746748344798555625404503892538388596134510723489025818969350462141402180659440212571965123644172624, 6536342231848874401852560601733742079598136017922220485108881196187718173937477688354876744059745076368298648543695003631380823961499911560771287712282944, 591207536617144280354487177395734742950663807240520111178856839755352973825021348407497867958530424713815674149850777864571644808608125073789228241428924, 528704344868929857648434087827795053954132140351368190019020071051693516304916535854107221213661309927939336463461776943711725678827966039404746539602636, 6140206450985440080394280315831541231371724782995851046334667751774388324125198810447671317208779131424110670224597469793022815006762905296104002859332847, 1356225412287106705210342502190316274353998745614327593603921929085622062850091152867221969453947634965416884126934303912297782681537711879501743368971627, 220246276334038015072631306299278279128888613267256806909574915902281142071591015536932649852472903195497088998439552622488516626474244903032447575901515, 6164565625055209367167606477660357164497521651293034305396673182836422306777829989665918784603919565091711929679532681632575409604510081469970110288441240, 4051579275275850438539555072937422993124292647526971308895899557214902799275412941162020255322392123576768873777028279578778226678165312344693556734084321, 6273569539461028280062068032874476288346796104115542721588424168568756994680402108968529155126432361968517001573296247944430490052240417148528981029914836, 3356393177467943443243694138774640867866772543779988191573608544407579465587721372414335927599262357472675155333304272611731957773076974814399848150309602, 2219796965340465757279398020204343965669528176704882780438267172139442434769543625728507180039195857734440342908703304931093070621073471959159636814374647, 6852982863807319405934691500923002724421852681781586498873403375613527487013280623322475521023039018662375200261256100401527645441015250577008616641295273, 104592721124890826185695001833990317615206135025215959822266067596552026897063630196168932156883573667437586941371625339116986886345410952870253198647183, 8182096372568058510686216213669659125425684584623143762268575543536606262490382495815067900454716579108192905091931598683782711182915093780311499353281014, 6108531381988847494532945416115501183148960474059572525473519704277326648576649234088056483086015451049361846937116469767115525863985325001657744916126577, 1308952084418296149368139831673744542834529232339520506738072317703479275459578744691968726980700922431104145146855482603394716087616549847168967407618966, 8044046595832507112209351458897520312132336249920093409800072433337834186253407671107015782362734126456242790515751636252881733324422446172392200247414728, 3363971329624334117234605714033759322651611246910194359278174778204597598321656983345605185972329200136299127385377260461481061897251675651467053826511253, 1011635691292471698405659418593119616274943380703061441706110856765350182110419789291298870981257884911877184108370956795518302139355981507210404847175586, 8608998953130043673190096474033161855880448236527580940353051525293458641852351299782334630811247110753737848609264952769157809667902326753797893032435952, 4418577655179120090653940890871156306575679428988575525086586719937176111390719030983033474188898709855193167704882789116178616170432803231637576545291312, 2063436058602891943166783682331598854897644742893832430693503547515462600781275920059803143795099994615574860564792822195231882961388256770435156717836202, 6001836293766406580877346513897237840332197986109415912165358819581690670283949214064504039533648143085637736760498392903867665717955108896943546830638218, 4130801792928159160645769736640872168667298146327648820568712561819473389149017079266146560479661716251751464879879160939902277261709931691418236216909385, 8974571571109657474794782971432144757385521705462927080885512087629455304604939167255028776281685849583355858654274689126474870573603722803598849558936117, 1742713698960303777701785209214963842377632113420354104282071214804792398675805340453758455401331740920759011812569199408292560799167811771189612244367863, 8280243030224062922516152489931384130598721387399941732900696789408584807743674302975333550128527888698948718688727862196983981035480535137223333592851419, 2718276746644413605695713422704921841015691864737432212017966954875923986255299836789778208106334029808253169794282324495553330590317773318983832151679461, 1732689483953985606826834448901903438109316523137766150683458580821920787642741808696408657311125255969982666522618993036865862849295907130999790703385626, 3431049360753951288145517625805530715811777608834003857232894741915012158584895394531402461175314814638144003293885427221757107343540722850654169171375698, 8825303083574216308749238143129787399198042504704263712199934995094838580466130062169283269413643522354892379467979389991022587132393791865543707488527755, 7725338086765671902462442653244027513318434072290186576778135611152894519485073635086572846252188081063786114048234491453459891686168840392306998076732777, 6918176390523532575160685423216048247157717582735940150358702679069654190085831135359325163422733201491103084962934338920864107986895652461857993563750958, 7214102172661488588766058924497754413663617389400932031299324393817287907175718980789825982821256647804468214342928675280019640242778422210516890006440291, 3465636398080356022969159798588911978397451311226650422426789653319425321276651269642068956937747487905612943751042995466716645842141964807987320620413432, 2618627429972509884773111677611069739749950016454165273158915173208062658473933221051562280697726656458112612779486908405654649984857251046099127572373231, 1935205482825647367988708660269728791835694641098628699434081528225279759197165364706943480135024218987804868565794770751034797163828381712836241172262914, 6389522908414702299169018585134756958702559576945127935103671239916914161012329252508050306834373238592689075115495565688238668725367743387752890451988273, 4664085267523681478856087989989350222842526861446357856048610839590856620383797026333438705280019959999150951057052715776677065800119083373439329230592135, 4500406089759771907545758663976647736778515429804510088397124795253278577098838151282316258209270180246474399942775179020446072740109992231621172096319586, 5926827796306350971180370179302653272003379370926041185219673814258919139771716586656497669916717398155072221387475388724146249757274339299917661146385547, 7967107599883591396891464520427533130575794991484090828739870936037335188433838163725684182632419083102267082494250425152740640517466385175323847995261707, 965080944794587490129002465268790895781142412155508644584188494936830226028770452834527890128473582945326493629653006299610646902165755584629662262529119, 3113616781041788782368414470632119369795093483018466229512006501474009322815937997549518256740142604579009124845538312063551874748313591709314363665928818, 5705018291901480769820647460944242809201206039278317664644395340687667982203651706911080805245011107565592448698459004018691419010958514068113849864801183, 3667588764305129475245894213482194701231579827065818861544407923476320256287283450903157970498755940405960480213512688004317228977876970596962520867862941, 8522791548606524997373278065601098416557388323808188316712212875695309523164286361960132339807446210931230788327250251014108081384793385563697840187426910, 7572614806919121996995144491054444308910193011222701967728286063873712447554021154456234005618712793027814411762923347639203947948410332460320578943051511, 3646950151251713266559111023994146104747635105038366391148876570969722893431825965725458197971440723089108315620147321793189831392816957142998399374512095, 2422152948978143981485665894712966315302211620559535907819175299291270533260406367560550394632527672478501732420231335018464398584521396500055826682000515, 6988595284061541071392772096592844278874954424678245161554549182020527191363249149720435427052068066699149845042126039689465450808252654859403628846660829, 2476088741774569816808778918021029628216123387486189095111445180784976359503053339880409398534418919077831718757545306582969929638376011834533409842105691, 4154724618961872572427730569635252799865841959933014815322738868735935580741620783548532722134301436093565555138079938734323993818923184337033033078765310, 1025328229700371788309422911832914087937237390028389164240864489773861554037430174089689402243393828298699283883265714394363417445260438476473730120109993, 1046965701676354358291085819894367370386530027180599599049000691094704682483380991605321249919479396046128735155577642088014491369366849323081397734913024, 8552676366705709327824192673180413355973481559465737811733399454526613990181446920569879642570137981333409840775874952534438183923125665581993983417902628, 4271910660249591987831168944808769014812427588156430013999305663976821370776512505205833485169471510812019964045977387000731519975682226505810110584477135, 4287640761350621638307827763508865844371650329805940851839001436797017758132521501151887567355908913218384952812391704948581106829694592107925517137997784, 5961523436580782364130760709778100039299822533046596144580227522355006284446230107297717632490525966357750311927912737719441159034677532476755082998298321, 4238677084565016962475407830310829109050673246071677907695292172762076109883520797458368596911949739343711664396623057946023009262794884562896553669722845, 7199784678300286697888175191853669607889525192797301379644517773590400310611936730161116856366971718596720709299736297474609192849805909635868639917372455, 3477375911522678345676981746483581834609795481221156705896720846382280280630332118191297380638461507136789396448758137015024731538746153785257728059335344, 3346523058756481706263755373364374875185967243916548523124536539767308274633244461689943524445519224460723932619257316636765139146868816336771242377601399, 8385698048781589684444169396418416617750096183537880204647732757022075985173753493899020794503339081431431797527662661185635897971682401438974397226934155, 778719744972187126021671130637495898639809290015882335102060343743886944717121180767952543499592280530077493731736222727911804922793724551850629751229870, 2820477812321210490848855941166719266763152821777548322712923520355957174406532392715541521567244874459060103342375293107779925253883785311683706933793836, 4358772055919669283111279783319215865040815940960553767829893302083688015475425903739475843028198840950640318251523333211376830674583093213312397731817837, 5491566642221957922252149343239074448830689521314299249782265635601612962444308186485322477709884612185088598282678880771636242195696794200575543020384953, 3695810017702052087758328849178951862716329203476314690695434529280282663117470055782488455846375504063759416763721050840874363210469919588674128850364717, 1928110451141223547286179454383777683746900274411301140660811621324198287771343721286189205961183862582212933398069273336202393467522804555169947032931229, 5310606147959365848023034948140074137408903208418049217966921581567089972266150442574150402954816040633344239083986014159648672666131020287518001431943900, 7153532860462903160225460023122220413485329201131971823313419379448773594179365915147900325840601040634297303614706969993827936922876859875521811345571172, 1624151678362999034310306687891127966551712411803061772652130120286269480373414670941698355419124067286361438274209466969560225586207137415320370756193291, 2686671470851696386114293641144107434096175611600219169871671725023412641548451902226125484254450967313267124532025652829018848548041170439520020902850428, 3618099201182194103213541988096941883129682068088027322979166559575393099646999810357084143786458894375395348559089116178675861905237713057926612313341975, 4172332279711208331818912334208589431538515306819766712732512227351311851417267389587375640676423244718183343435841962592322888131718704537206506028355454, 857014698787549729164334952507110420395168925966283559162684965237741275923831274919395127824094829032049933841783802828477594107831106933959357868698104, 6924672746105202620509103441550579345186306403272821178779450216703902665310569430299049415436025545231456893298445688301629951100871981326200494020390224, 2397225900338275113380887237650773765247670964186821555434704600671910797634046504368132024263986839733960796307135660226932460220818739653335081215548942, 2417233529534594218847661396472542387426866390550510888182752069606004353294740784208855191241879806587414262017493423472303005668720239310845487948602106, 5577583799618953082585794370721670117228194319348919354893625964038757920432839226965435198339827225422498035139356288000493141640603141809900835814975196, 1780795191577490854337651652517820190697302691700423826141867246754928553315994506580574009535261488611760980096870323411431595827514765568149128314829541, 8081337713149364158395796025135772513780067741752762610819480256674159114208229056783045338160288119914681650426540630475624058395731205969427564467159215, 5020846572595757924612863986669869355349789213229138055038084015098689607274788951532928102516450247576402526094514939521922204486623122834926331556676880, 7430945367783566934500989791563413382358523758430861645337544500153936468026749012692993568346584514337974972811637258026505895418431818586591261981352410, 5027088752219736884996792150331597623128356717444635848507706863588676494169028411019384944853138141614986902396305859726013659337764829269940350072799965, 8938404336021500570308397229003170832819279152565841369227163579820765633099697443950748315729911578932783144413128352657165092753876790556550280036627639, 2036506696090526588250509008745076118290023444042083401654600876637030031118729519249785899578254743642178469328984231564402783363925641754618859078914006, 5520326411938272201217566269570077375723103284428156276353517355813582440117210415596025472123974895563671998506655450455409293001579414862854193424848134, 1161864687514871777769261162772047898286799517603977954379928995630143527385976740362229566618447164317441322070945053254027237965560759425712326186193852, 4044516779627072510409718524136917068017667481466081694700824256242741482427755125770877555478595345147760133980451176928175145634651880673525185080449276, 2610908653915908113567865646464503981137551402048372940508580552854371275879160862043400898599841343932370958949821027284475410699021108636795488225330361, 9091395117310685534019931995371753191888125171080542591667768033666219132727523238435322650372720264311662861767660050149037809082342863886891651402430791, 3128882488404733664520627329102072868324171140416904829432281239434589870954713187025979977529017693553066391089830190924839597878676937846586320829368710, 982452321852400488828896034367107452729701932005815312255005245923508689641967574458436887468975334092805708605986157008233260305325437554526668876735201, 4100779880240686966354106930753409261432020660983835647141165385330843842621102395121237583743485519813220553694874968251860898830605477955186624036684894, 2559256391899776954075409884049367896555794574657553355120667417770881948051840074894384843600525439212432879006562150127907395315031138287691898398307926, 5511332085606458638658436770754714006167468582458779767230496976864908662403473731704017884565434555109513026137266361722300397431324563289610166589981400, 5944869895586295740578933917360596460927368895080381374220512281357642105332783565316274454146540258867347601325725862469908508800440047023915869790727964, 2282963831669436553784100930344932190410496737288308197628409283941264051453984485825726609774956449586160339210637548034321615306692230722477792435944688, 4920833105555181253458419690212123211986521232509140567601395709684783104018774953415838659278444748611328922456686007084110767833583247269691598084914226, 8185213031717962588214606587044115621331983237057486285818028451282863035295224776576856546151734272929747877006792816548492527871164255533546978137470170, 8876999457467926121897292113956603922331397545978275796274901497865239928835339190986036428730528380615513911901900719270370773414417942803668594155458157, 5750246372444936268789762528861845478359430656520458567890300577030911023204121644519366376098867870984377922410854037197237799142465400304458009228555484, 5264059912372072215529017236367131039850419139406602728845132999460610206764509586090306987700951529874360131816138545413425289898888795953427064564266661, 5061454829437475563006597751697176449936867321853973519217643221150762774965325000375650999882140280107279842971086285376062923869039314241371882713543151, 5181484217689462258166448417063037535968707288432800448323267001999960348127335423449022907682839748093080906646079397396887741649533480584310675443942798, 1006465530903700487276286722877395808197038649014057957240898333668105878979289219741155371409499620682019358749502959837303229536607438480344412541719861, 3873846288894270245598323049912400563955112487918534075877138778972718945736994808154471059208937796399000085570961467263564958238081182090827295917266146, 385038744015879087517578165611233415895697154092305164861115008772594297863500493897620323923645462753107951768478259300840981267119630890981462367019533, 2879434006470458303571208811554628347210913200188988415288972639282390074543731500035531024458819121200737943921282061287456224216895134319751201026601754, 254444329451613956542807195088764608959383128987973083359991038650258520844022628846468351313795369898971780657649590186890126164026194194488033008086639, 1665782854472218191371403504505146174440618481492762920995269300277049014178928552242288700447973636625963203092859797867381511369612416753280023672450167, 6997775702017515960958225620824788752167774140428900488456251234785442464595873544313162191863916552720342702719512150231597265588532682576141408920737682, 6920741361849681764589809020898099522431431537575817284757970180620266218198869332285700254038178909311977558822125807941651513370533792866390336013004294, 5978793478066800242001002831070905949875449292757888824497160776688862898033781008711163892406887290379062013983813509682831383214803856711748400097933142, 755283664662118048172192672035364495897275951812194978705545350393441932420404939936059118909645988459706772170919665912410250422284639901264317290538266, 225801124664729566261747177382976222208794059924537281641140407329354364760292677150572107044045977361224108765989444293269727262429640925123069841079508, 6333061836331240931921552338314130165676904677085583473358385978250086866053829256377996970254768363572658759923409764368347203704575125278610167427045103, 6701574066772153678953881896248135951010052969401750914600543576465541146893849591887641305825122945576314177197200152946545553184125226941061542256929849, 3107838735274443435605041886519179234373633032282564253189761481104253216462043467876116522815003633087624036417791944169034195430399394249312644997531927, 338229589396829789353983733941478204213365776974965845031923507791004968385274552157171471840693734110234735067738456768836913993546128360691936639833717, 1591089694575442030550612766239190644995601444217971774760928095835285544411731887699594423819136683749486305666778975396885099416584156050568854210247017, 8578853439931143491044043116163033916437510868193383267371444577428086025329542051598504293638360189096716423833425974083322112990824211661674807695991265, 81501209506130987968212800632365719667316053579316330488307387374774992654205436425933966680719887062669480448161808761237836109496659287109905509730084, 4788762225293063739989379255463846240384275190974451298552828371417510796627834624859847670326854163057573253409953784224516794749574233198777461108722899, 707693755618515123665842355719180193274167146789097950331077503445900519795722354469739640246017461836988549185289410605007202607593747685202679820964995, 5532344924508833455140559192088846046156578457966427804351435666858737165368914419404231796548851479380336531482859534191659799471829451823680640936121566, 7099414007803495043259079534411239940124399615772684092870303297127417417182434185456417153528524347178416081087479723881385064202149958780754243790986568, 9063006604583535571869838833722741983153023547555773566910521766796502342235064998762927362332333968370712277522278269817885635781121706686819144474149326, 8021632194670972780599293225440322129469905184007163767708804570430766770920905591708472405053451944728344669927240569319383917800851000889878481650768725, 8409183698027863425999536762541201888269904853304417001350862539689155076578505808447748539105338359647918763386241744682909615897014089923356324927239947, 5415028558827491294934465039923810888800582618485963836731297586611694095740772485475878526667562821519047301146991893738656377942425379399126197469121550, 1383684571055981103598309289680934417464373921922289520054257724919409699526141425435934763658245485101241109525252875608587125358748921494836829890881265, 4238885900936155857850823926101733496921974541972363815223803849824991434397138437538104739833295403189132225108024908345177234956208884554593012846845813, 675263869228198292639488031274196457568211650896069666047304472610915178120523751703879198871084249653983410997284392913580171910832424946471932603435890, 3148242198305554485244561547425426692395265806949418345752461115719204857537751225287701344371700555040790021224904632410933355298424040096160716839366231, 6733466814070291214033529066062411700729600134083176034356815303679577864998074827186603000557862505027145295272333401842195435308850026209882460593607903, 3809609961614546035997176178422511330661768879100958163166542432562277923371724885775292624074626804860756466820588112647086112638096536612064181307950199, 597632398703733996288395706906135949708145830291309165451420153997714618967700907323987261756390694827044573809684984541542510241561101239456366116053387, 6333474480715268205935990060083442540266141679775674942355110350572701898438355516803245683574010419526999283476442074858514832785019510958423775219790988, 6791464673147221890208431134156987214456993144156995830928814751517640139218823929148415125947536988450120215793521959008439783162098565581828819510380268, 206274643222199488672049818011314880947894990920390969476163034917247922488595382976208769026639256491031317668609252390189167055412770315253550470787529, 3778478249286223741620070924589342157425798529020516691035727442004100879478914798650132944667072226528748666008730390430377084876881659860675946384244140, 1770190630487182636284545248615357198225400411886300590421413493981084375320182159309954167156075649960230934351426801770200625748045740356693477430678986, 5519671882720493039738331228161958715518849722233662866086911835986151208360584420851144417800142292473502831373303226637498377645926428334646442345879570, 3798929006277787851478326755776242691613866006572187889748800092781493099608810183260411307154669451562536336062795547021083241774693404440772773660024285, 7607989002704433736550067251785904874385845576282133545940572676196182422455994401112620328378381452198043255809393425516814865565320514198744145268717388, 352251128810910333732399363662607359847500870391333795568542705273576543465781715689257887519392211330454853060627865230069546602644076365183826001631006, 3444033885520361768758939327024884061460892532472862884372204365285962267299546611954959690605647461672552098075613616736864319063296793797354136766240189, 972270166145015987806813527099869892895695829616612025035334307484955330005256792711558779272463562868192780896314793255445479635789740569834948800574977, 2499260924511944478289700529705008233439941327113047929257378882354167826107198703438177526423724027740803812191643078349824469408243428323770338970317451, 7969479816174545994805796711734132415438134262920593698596996702019200221429345736378459245259365909701769037128921082175871018413502121363380313015456428, 5309244681145494586897068391602737204842060589767878520869707321949093074854644750712457382003704642800903448034613492966118494618779200357421484671523319, 1105549195368556479251583371042434178887184777844019591781651376051834158478996708262191407013157798459195944249177503862772857797475613216788969773683065, 787879636391158880651535232491649346561473397586515874661314456859375907413509304619122671541450448207578300390295539378137055567534871237038326681389254, 6991502064364802434386329567949227889161495818220763649132329555612635557160435257181060178969687733692098299486106046138335820424437087258193883562722339, 2266483638153551488649208038823317433656490064386929768244912906490730747174646376981521948124368999928323430027634811333230715667699469053679378019579626, 1409656689564696211034193374258004398020136255341400337654774703406366589945632781112394864923164415927513870886234682514861097962105298668320742175056978, 2233926414227316845114448047277912571876689758200962041901863466660725513011621048540429535707406192211126667950065768388009561808365985743671511740772932, 2466832708492408254946966487785377850842344894568607851295428136548201825637337256385945255888638498939288299872692689850055861378202912718594312174875534, 7505930706933763613352822580833292057012378241368363305708520711206267272114736213140676288465605515675591693652305706436433812433189524521098615604686956, 8926108493801163324067668010486587592688401091529008454177057349581325111498358507201478477410864188471129698211480906440575205672152786562176266745334403, 8851792294591325226035413458887644782005806247283109870731538583226994417030940951820880644928513030765628044474931640565862773497325766014066506564690881, 8073840208271318220131710732532451903708506382847679869445745667273211252216946135749752164090478236806785049379011295172339585355548520459882401558594140, 6408046493214531773499813451901380980465682394239926867098003856001054362300269505883829623688950224171174555604314184266690407156727277510751363316939709, 792348997445172981677436754280091206389436585398724095297858229074533953380585029588016891315361871175334861487908539942913914123839405425298892213621826, 2742093239764663057130754895132462690798471598729315651525471557312266795051536013668769771704579819962024297129409578250332828513655693080046384009887674, 2384538962075643238598788461179616350239862232510028485449812436176547576369937783212508947487356612868440796704223243113621529337874905456255146074376436, 8915160987749885988698839173174570789325012078877783123248576669535341083915961140322670429096655037127184827924370774498317196749106955625442522674200511, 6235050394449854241312983163798417242929702533543889020268550705736513741898497061056610873778288377404239549698517477557073525336284232370098477393636613, 2154700184312634475323411612676890280364499152784413390114814310472471551766209578352650527032556463696262115302631653598288661206752654632911153523699436, 8020820889065954742114474230335491336705991894645479964647319840866236791103517974969473863215845727572727370475798583547580421675044212516929165826548296, 8507227900697714640568474412360036933770215773424565204599402867191102992222636750154915171384488680007646672097858658259781214699616694289353011725421919, 134467777426546214630985102360711953537367849492953711909774212772092275657267010351309106566267407619365910234522076226422126446291303213655615521121703, 3367279101638428272930353996468449406310361913451140055912322696597031458933375325730890588915598733040976906221706772215300286956225569174825766521908406, 5888265871856547306387079197601029590206590661496255841271956512100950551249022402460136170711210088836370208999804585995904250514577988648500049851063268, 8592250810911694625323609134144654544113175448105922843653298410192142799370634953053080971458298452175524909222023136399121619168662037853095958746992961, 7693354507434964803376159529089098793037387502477297789003853964538821064510778663546264638949737538691155816352275667875790551962371245515669179150662646, 6201484358526666767230820248216165757101358564655873895758897786050942297191588049934230785640257503399282195502106272888455921080443516006795255943184521, 5744083679780991228958376557299231821062425503681926045198361905733652962697598982903326974147812821316426196638056430841575763179141739082726493072281535, 2028609385789441612223804400688859991487657456496116671319278846026963173430721412361309818528771721966964665748545562343089579975440392808244392545327416, 6777474918274418151817468018551056421706112431212219947673362892143505251684648896754379355831708471942641070744137536811482251010117720967711644784544261, 8383147342396827857037984924584988866390223555420847853153587543714347315010340972568945118367607573411119797521377611428093753466661546217883956678419939, 2761416855549725265339413473882183433308804093932093719407457289330896405887565643985535050692570632743411173499067562072969845971022016024628796177786226, 8028553136623898155868668117838474118334133028344354798778004428298562695826190213149456053717407843648972299961015226926491589062305978530849821285337348, 2329875747352436465605414610587908144952317459192200528482275480401550388309137042477654090262511345946870990174758411025790298593090302235795448844517916, 5196472754458908367095686965337724550894328612686157247660112986566526476644816423798773504662589372892442631090771712915056920385555464649467853412865704, 718400735485913615082315999363319754143983919345639515222617079041447507816277955446629881587395353242295067633279077178053824587599296102461894037317075, 4220171576197262542398999584475954254544681408031506601622065313140964789525392048947481199086219339534205890688307282217438218070600155645575884372153022, 1911055072753176491905510579021466320151196169413194754421232631144236138340538063952259614424963581352437428181701289411699666776515786194312279503775692, 8426176822852123115358202665931923543093197147753467346982749631963385825410668134306893340670063830773274625130908533304862714861534199460928994897430850, 1751776623730776899859303485771637902345279518609672138670764737722424632404475715165221091947553997613557436878512614100925179900146558909898314335377730, 3330806117407143323225514269664547779387581999132239512177462698988560725084185501123867910137765415074295833990999016404897940028796664552009848269508997, 8944260619760328425484063669051862013558037116416661753066643834469382854640766293683921012919262898850307004381840473005469665648980003805892872837307613, 8634806969460101242488271446331158316398850824325151404542367952752829234588281856550275846298129566512678341717761222779054367277673840934691702281954233, 799950079495290627490778223759695454923378150037059401109194162068043658593777060660261505979952297686436419789411835705939339197184352384601304627537391, 1354883193662230244578726578828578550934458482470224161570502222984673178574259275237820544218577490793588960942507225125507203277291744941239413181629621, 8908310514683358229222214509407520439593238639502841695654595282509153125513232201499374921137043322009711420654854678428959526447473230200252181049096485, 2618673145649647949619665003301137859996236616176278573690145850143235060247494358905600603474976545645876889426302041963330555571715018334099537834711213, 3065243309797310249623580010756049249700716553306690928610358687693176979706040599555183522649789383740658906492314696818935742265924859105528132305421698, 7612050682181250714780228062584972426711395936927641720172301635568951141273335016856642483535542733863285138944752244697892381242776363547601976974420728, 6014652205674212791588352687919616221310480776978304445220292785299511537267620647432405215884103142369957065613686297042804172492942326095365915525929244, 1548272775920412491643731332846851633751118625127982880475426077212976887370743833253765526916412943860135722090486112662041563941628128084259316484086696, 2697710247341454844513390358991685000823500781140238952046608359080030524866753605534837156939780293431193348266785205791177492450658113548093944001157455, 5053873378488083682191227361504496485832503801672552314208066999439147743872086194892191604071389190884884137595116984419327443861000109776278043097179167, 7712681368882617899674375746062711944484262956717573299508734652476730765277215161503948040352104855454223309550717782126407335539365492244056209300795240, 2323238967403877633783240928983706513784299850336741306288718272962367207804020595553333785889350554259603650440605024230801657884013995489506752603034782, 8828593595112809226521364761059065366922937035105836425373826304426996102428327010768248382144447434758123196835770354324910503975163575074434580161265216, 7202799002386457858643092879795581485848156429015344726967054139445928944547227965795071515009789027342262841369343359109978559392777576239548431888013159, 7042232546789165983458746083371548838155532758966104264564637415032547442144636705971944297014359786077081989777334128165085720646419845972133479420716848, 1314766174141769614313801476722957662070963427952811591407762399540629746211185258920219222941603821538532433288999555455716686396356093053936819302385633, 363904242604643121999963698345568830752327440543351175121511416942405193028899760684139707042904777416902477465866738762381099877648921582161889359556249, 5188372296431565369273716823263386797272981570832535768927131543191841633459940376175197261415064633963655365828425033475075988894995479385034467394844248, 4886295847601737247922088901447472319444268123206774697323795957394656417160435338180412603500202422025872315703611458315525125199408287050369974587559874, 8993771837360874474642345688322634311620659239633463042378910171451252295070299849956872265165067684372408814512781896251478579676754333180404965020111136, 787024474265791250675655649529290258487207254974874127790402113450768785189388419962030572289357614788241335756376953739371107810594002272699782151623450, 1896242584957310699080813221710329208294654587768766181480056942043696442426645078300293303146282610979812103618769639328000595551951550210607700753190683, 4086629046591058028157766044699308531408943045773163859928408215977499493940444038153397760190372073768838389749316739090319838373993290774286838715502914, 4199584905162047306688515960266873241761425086344777581781292926035748006604987600574893493366393880665155042249055208950648436264135604134741055909952644, 8248840335607156191171276522407538816629182804008232151518805530186210142324046058907852093362820746978864297431465660059059050497230308036365574488105643, 5206924886417009570551509674613659593990671299908647760310313626672279146908206890238763234766475468620558187838649062771786127493319266470586307704334663, 7890180421555129114069455381717241029848085239974905639690878471695177847456639107020203348745988107507185205041797006876849449912713519356711161933657209, 1002737948708750475964184427041196426146986468202966118747155800739284913356201546027414254956988793276936332840548158811604592315379068016810051275764426, 6925584899367599763240870643938009761513594525296917644545552906218208928892882060556715931360579599683552995869389833720044154469712908886228479008004245, 3583509821563760461673684072657753320943488901031564188614242208696719528587059312302770640063648886168989384616445519076447127882017467669560563475222933, 2309090820635754101526502773311285181815215619737246682053037289857824283920321182925225607717160167577451400313562813255653458687032989637472971677121569, 990748065141128887387914317520625710108989715726395748695205574861291801390732071660044770209448652772748324863732351718536658351790436251274062786447092, 5114213164252061681807821502076284287636531791235106385075089229259944001832533585611305049855582595574858099060705072316160566323905029731082475359004063, 3999112762581762647846547237719343241114459038279076201344528202312068867464458604454964679562244497179130933979955805321985840512205906473308985028874228, 4275582895679987653503252646438623431082644006010509243375691070008951957027882487941865622629641847554347400099572958095234883343983878324271428198914908, 3814504292960373217658070038113018699208887783236615473335179417781479029092450282014188834389726644206951867076380634740632592004509032924830670280405038, 1174327911192387259017841177035972304486320164147523065098008959439816529050657145487658020874942783162189667148207820440389463243293638578375055916082730, 5572511562415219795787798683303321428492642172422892823000964154371776691114188913504895498424105709667467670487894796994588086125799211196903596633721458, 6238994036882118850646954296370033132285759490667921224600684568021878983748498451290425941992731952349731874904466743242187879233746570305951330305784616, 7420652165866325104467819590633470668668035150458504012428487538857205513020453979193737078952610147118769745243612089441627491942429109703275008481083992, 2537903679390267297670842844811925736249656037451160982288849896719775633306276793655051753049241634179523167373102496814628308928063217449935287901871681, 4354322856097752810579716540588104309281445900976785405526451596554553073473605669596412452710273932031652659128847997092112792393793508046645834210951575, 2831992082496621382671713221454671363293296961777614620167772407550696842817119220584203789557029685000741806290478392235847791280505153384948966422551511, 4829874402957300606074916766480056476635639218299898254744577878190770425826630217955991830183967615031238437621033191430316646535529361935861070302610227, 6124825517510492922349671966129643973042175212807775409274613483691233666949447890421473951965616107871612596656326170398023187489011900993002104243461392, 942860107134136391136225440668098893953561672924967654311787712625330843478011976643942528903950489894366210599878470363955635924311035134067169374118948, 5904964932346103930864994107262997739219952113472227483081892684788672358865248224887936488916426640231057332438418912114600810460986023821589388506331083, 530186328355809468821868695691785591283536081030249939468274892236633126886225798887602980298021585707807106014118350224502609574290868113036792879118312, 3848848307191269762635185530948831552481074746780320413854162016263087241352624537037995801696802740773888848553816701735608302419981716267859854983906749, 8665780077583562769970039497386856110556848319851660291102027014224664302866894832098764263086335381816180521722439274768818428414810494960824143823509510, 7834335922074909825487335320833846138043601576100454071355689389998191219930612089235367488676328628242269968429415183827766782164633879850085389671041847, 8510685206798750803588925177975118618063114703479132257365005674455462907301717308135648369088890595769744801006375777107378203314748366132528769760749417, 7929931528416018875841878647272637747481665368921810150245496106951964491098081621619913691758753414546198072347545539277701459980145019831894512969306986, 3473751827072329766896446549868561254104394779048729593426514010555800669916576767709679481696121492335103161901091255618441094965150207320684923954678060, 578064721243911504057772886059968302602120375217028308000049421802524626914679666556911562522427412861890049498133401072349233755336883453190190627041202, 5222794764985350195912581098964234167742551815203591156633161605406225035926245577837147378916987621745362575198079648247067531358161710094130986041661267]

bits1 = ""
bits2 = ""

for v in out:
    L = pow(v, (p-1)//2, p)

    if L == 1:
        bits1 += "0"
        bits2 += "1"
    else:
        bits1 += "1"
        bits2 += "0"

bits1 = "0" * ((8 - len(bits1) % 8) % 8) + bits1
bits2 = "0" * ((8 - len(bits2) % 8) % 8) + bits2

flag1 = long_to_bytes(int(bits1, 2))
flag2 = long_to_bytes(int(bits2, 2))

print(flag1)
print(flag2)
```

- This script:

1) Takes every large number from the output file and checks whether it behaves like a quadratic residue or a quadratic non-residue
2) This test tells us whether the number under question represents a 0-bit or a 1-bit which when looped over the whole ```out.txt``` array gives us a string of 0's and 1's
3) Since, we dont know whether the encoding uses residue = 0 or residue = 1, the script generates two versions of the flag (as a string of bits)
4) Both the bit strings are converted into bytes and printed

- Running the script gives the following two strings:

```output
C:\Users\Neelay>C:/Users/Neelay/AppData/Local/Programs/Python/Python314/python.exe "c:/Users/Neelay/Desktop/Miscellaneous/Cryptonite/Curated Challenges/Cryptography/assets/All Signs Align/all_signs_align_decoder.py"
b'\x11\x96\x8b\x9a\x84\x8d\xcc\x8c\xce\x9b\x8a\xcc\xca\xa0\x99\xcb\x93\x93\xce\x91\x98\xa0\xce\x91\x8b\xcf\xa0\x8f\x93\xcb\x9c\xcc\x82'
b'nite{r3s1du35_f4ll1ng_1nt0_pl4c3}'
```

- We can clearly see that one string is gibberish and the other is the actual flag (has readable english characters which match the nomenclature used for CTF flags)
- Therefore, the flag obtained is:

```text
nite{r3s1du35_f4ll1ng_1nt0_pl4c3}
```

## Flag

```
nite{r3s1du35_f4ll1ng_1nt0_pl4c3}
```

## Concepts learnt

- Learnt about various mathematical concepts used in cryptography like Quadratic residues and non-residues, Euler's Criterion, and the Legendre Symbol and more
- Learnt how mathematical concepts like Quadratic residues and non-residues can be applied to encode data
- Learnt how to reverse encryption algorithms by understanding the mathematical concepts used in it and reversing them

## Notes

- The PyChromedome library is essential for solving Cryptography CTF challenges
- The usage of ```pow(x, (p−1)//2, p)``` almost always points to the use of the Legendre Symbol

## Resources

- [Quadratic Residue](https://www.wikiwand.com/en/articles/Quadratic_residue)
- [Legendre Symbol](https://brilliant.org/wiki/legendre-symbol/)
- [Euler's Criterion](https://brilliant.org/wiki/eulers-criterion/)


# 2. Residue Refinery

> The challenge contains a single file named ```chall.py```

## Solution

- I opened up the python program in Visual Studio Code for analysis

```python
import os
import numpy as np
from secret import FLAG

flag = FLAG.split(b'nite{')[1][:-1]
assert len(flag)%2 == 0

class Num:
    def __init__(self, n: list[int]):
        self.n = np.array(n)
        self.p = 257
        self.f = [1, 0, -3] # reduction polynomial

    def __add__(self, other):
        return (self.n + other.n) % self.p

    def __mul__(self, other):
        prod = [0] * 5
        for i in range(2):
            for j in range(2):
                prod[i + j] += self.n[i] * other.n[j]
        return Num([(prod[0] + 3*prod[2]) % self.p, prod[1] % self.p])

    def to_bytes(self):
        return bytes(self.n.tolist())[::-1]

ks = os.urandom(2)
ct = bytearray(len(flag))

print(f"{flag[:2].hex() = }")
for i in range(0, len(flag), 2):
    ct[i:i+2] = (Num(tuple(ks)) * Num(tuple(flag[i:i+2]))).to_bytes()

print(ct.hex())

# flag[:2].hex() = '316d'
# 9813d3838178abd17836f3e2e752a99d5cd3fba291205f90c1d0a78b6eca
```

- I figured out that the script does the following in order:

1) The program extracts the content stored between the curly brackets of the actual flag into a variable called ```flag```:

```python
flag = FLAG.split(b'nite{')[1][:-1]
```

2) The program then assets that the extract part is of even length:

```python
assert len(flag)%2 == 0
```

3) The program then defines a class called ```num``` which:
    * Stores two numbers together:

    ```python
    self.n = np.array(n)
    ```

    * Makes sure all calculations stay between 0 and 256 (modulus by 257):

    ```python
    self.p = 257
    ```

    * Defines how two ```num``` objects should be added together:

    ```python
    def __add__(self, other):
    return (self.n + other.n) % self.p
    ```

    For example, adding ```[a0, a1]``` and ```[b0, b1]``` gives ```[a0 + b0, a1 + b1] (all kept within 0–256)```

    * Defines how to multiply two pairs (two num objects)

    ```python
    def __mul__(self, other):
    prod = [0] * 5
    for i in range(2):
        for j in range(2):
            prod[i + j] += self.n[i] * other.n[j]
    return Num([(prod[0] + 3*prod[2]) % self.p, prod[1] % self.p])
    ```

    For example, When you multiply ```[a0, a1] × [b0, b1]```, the program combines them using this pattern:

    ```python
    first_output  = a0*b0 + 3*(a1*b1)
    second_output = a0*b1 + a1*b0
    ```

    Then, both the results are reduced into the 0 to 256 range

    * Reverses the two numbers when converting to bytes:

    If ```Num``` internally stores:

    ```text
    [x , y]
    ```

    then, the ```to_bytes()``` function outputs:

    ```text
    [y , x]
    ```

4) After defining the ```Num``` class and the functions related to it, the program generates two random bytes:

```python
ks = os.urandom(2)
```

5) Then, the program prepares a place to store the encrypted data

```python
ct = bytearray(len(flag))
```

6) The program then prints the first two bytes of the flag

```python
print(f"{flag[:2].hex() = }")
```

7) The program then encrypts two bytes at a time

```python
for i in range(0, len(flag), 2):
    ct[i:i+2] = (Num(tuple(ks)) * Num(tuple(flag[i:i+2]))).to_bytes()
```
Essentially, the program is taking two bytes from the inner part of the flag stored in ```flag``` at a time, converting those two bytes into a ```Num``` object, converting the random two bytes generate: ```ks``` into a ```Num``` object, multiplying them using the special ```Num``` multiply rule, converting the result into two output bytes, and storing those two bytes into the output (```ct```)

8) The program then prints the final encrypted result

```python
print(ct.hex())
```

- The challenge can be solved because of the following reasons:

1) The first two bytes of the flag are known
2) The first two bytes of the cipher text are known
3) Therefore, the unknown key bites can be found because of the following equation:

```text
known_flag_bytes  +  unknown_key_bytes  →  known_cipher_bytes
```

4) Since the input and output is known for the two bytes, we can solve backwards to find the unknown key bytes
5) After the unknown key bytes are found, we can undo the encryption for the other pairs of bytes too

- Planning the approach to solve the program:

1) Let the first two bytes of the actual flag be:

```text
b0 , b1
```

2) The encryption formula (special ```Num``` multiply function) produces:

```python
first_output  = b0*k0 + 3*(b1*k1)
second_output = b0*k1 + b1*k0
```

3) Then the program reverses the output so the cipher bytes become:

```text
c0 = second_output
c1 = first_output
```

4) Since we know ```b0 , b1 , c0 , c1```, this only leaves two variables ```k0 , k1``` (of the key) unknown and two equations which can be solved simultaneouly to find the unknown key bytes

5) Once the unknown key bytes are found, we can simply loop through the cipher text bytes (2 at a time), flip them, and undo the ```Num``` multiply formula to obtain the original flag bytes

- Building the python script to actually execute the above instructions:

1) This script uses the given original flag bytes: ```31 6d``` and the first cipher text bytes: ```98 13``` to solve for the key
2) Decrypts the rest of the cipher text using the calculated key bytes

```python
P = 257

b0, b1 = 0x31, 0x6d
c1, c0 = 0x98, 0x13

KEY = None
for k0 in range(256):
    for k1 in range(256):
        if (b0*k0 + 3*b1*k1) % P == c0 and (b0*k1 + b1*k0) % P == c1:
            KEY = (k0, k1)
            break
    if KEY:
        break

k0, k1 = KEY

cipher_hex = "9813d3838178abd17836f3e2e752a99d5cd3fba291205f90c1d0a78b6eca"
cipher = bytes.fromhex(cipher_hex)

flag = bytearray()

for i in range(0, len(cipher), 2):
    c1, c0 = cipher[i], cipher[i+1]
    for b0 in range(256):
        for b1 in range(256):
            if (b0*k0 + 3*b1*k1) % P == c0 and (b0*k1 + b1*k0) % P == c1:
                flag += bytes([b0, b1])
                break

print(flag)
```

- The python script tries every combination of ```k0 , k1``` until it finds the set of values which turn the original flag bytes into the given cipher text bytes
- It then loads the full cipher text into a variable and reads the cipher text two bytes at a time
- For each 2-byte chunk, it tries every possible pair of original flag bytes (```b0 , b1```) with the key and keeps the pair which produces the corresponding cipher text bytes
- Each correct byte pair is added to an array
- Finally, the array is printed, revealing the inner contents of the flag

```text
C:\Users\Neelay>C:/Users/Neelay/AppData/Local/Programs/Python/Python314/python.exe "c:/Users/Neelay/Desktop/Miscellaneous/Cryptonite/Curated Challenges/Cryptography/assets/Residue Refinery/residue_refinery_solve.py"
bytearray(b'1mp0r7_m0dul3?_1_4M_7h3_m0dul3')
```

- This gives the flag as:

```text
nite{1mp0r7_m0dul3?_1_4M_7h3_m0dul3}
```

## Flag

```
nite{1mp0r7_m0dul3?_1_4M_7h3_m0dul3}
```

## Concepts learnt

- Learnt how to visualize bytes and arrays in a mathematical form (in equations) and how they can be solved to obtain unknown values (the key in this case)
- Learnt how to use brute-force attacks to simplify the cracking process since it is often the easiest solution when the numbers are small

## Notes

- Nil

## Resources

- [Python Classes and Objects](https://www.geeksforgeeks.org/python/python-classes-and-objects/)
- [Python asset keyword](https://www.geeksforgeeks.org/python/python-assert-keyword/)
- [Python | os.urandom() method](https://www.geeksforgeeks.org/python/python-os-urandom-method/)


# 3. Quixorte

> The challenge contains two files: ```chall.py``` and ```quote.png.enc```

> The name ```quote.png.enc``` seems to indicate that it is a png encrypted using the python program given in ```chall.py```

## Solution

- I opened up ```chall.py``` in Visual Studio Code:

```python
import os

def rotate(b,i):
    return ((b>>i%8)|(b<<(8-i%8))) & 0xFF

def encrypt(flag,key):
    enc = bytearray(rotate(x,i) for i,x in enumerate(flag))

    for i in range(len(enc) - len(key) + 1):
        for j in range(len(key)):
            enc[i+j] ^= key[j]

    return enc

key = os.urandom(8)

with open('quote.png','rb') as f:
    flag = f.read()

enc = encrypt(flag,key)

with open('quote.png.enc','wb') as f:
    f.write(enc)
```

- Analysing the file lead to the following conclusions:

1) The program encrypts a PNG file using two functions
2) ```rotate()``` function
    * This function rotates the bytes in the PNG
    * Suppose there is a byte at position ```i```, then the function will rotate that byte to the right by i bits
    * Rotating by i bits to the right basically means shifting the bits to the right by i places and wrapping the bits that fall off back to the left side
> (The key is taken as 8 random bytes)
3) ```encrypt()``` function
    * Applies the ```rotate()``` function onto every byte in the PNG file
    * It creates two for-loops (nested) which apply XOR operations with the keys looping from key[1...7] to overlapping 8-byte chunks of the PNG file
    * This is better understood by the attached truth table below (for i = 0....5 and j = 0....7):


### **i = 0**

| j | enc[i+j] | key[j] | Operation |
|---|----------|--------|-----------|
| 0 | enc[0]   | key[0] | enc[0] ^= key[0] |
| 1 | enc[1]   | key[1] | enc[1] ^= key[1] |
| 2 | enc[2]   | key[2] | enc[2] ^= key[2] |
| 3 | enc[3]   | key[3] | enc[3] ^= key[3] |
| 4 | enc[4]   | key[4] | enc[4] ^= key[4] |
| 5 | enc[5]   | key[5] | enc[5] ^= key[5] |
| 6 | enc[6]   | key[6] | enc[6] ^= key[6] |
| 7 | enc[7]   | key[7] | enc[7] ^= key[7] |

---

### **i = 1**

| j | enc[i+j] | key[j] | Operation |
|---|----------|--------|-----------|
| 0 | enc[1]   | key[0] | enc[1] ^= key[0] |
| 1 | enc[2]   | key[1] | enc[2] ^= key[1] |
| 2 | enc[3]   | key[2] | enc[3] ^= key[2] |
| 3 | enc[4]   | key[3] | enc[4] ^= key[3] |
| 4 | enc[5]   | key[4] | enc[5] ^= key[4] |
| 5 | enc[6]   | key[5] | enc[6] ^= key[5] |
| 6 | enc[7]   | key[6] | enc[7] ^= key[6] |
| 7 | enc[8]   | key[7] | enc[8] ^= key[7] |

---

### **i = 2**

| j | enc[i+j] | key[j] | Operation |
|---|----------|--------|-----------|
| 0 | enc[2]   | key[0] | enc[2] ^= key[0] |
| 1 | enc[3]   | key[1] | enc[3] ^= key[1] |
| 2 | enc[4]   | key[2] | enc[4] ^= key[2] |
| 3 | enc[5]   | key[3] | enc[5] ^= key[3] |
| 4 | enc[6]   | key[4] | enc[6] ^= key[4] |
| 5 | enc[7]   | key[5] | enc[7] ^= key[5] |
| 6 | enc[8]   | key[6] | enc[8] ^= key[6] |
| 7 | enc[9]   | key[7] | enc[9] ^= key[7] |

---

### **i = 3**

| j | enc[i+j] | key[j] | Operation |
|---|----------|--------|-----------|
| 0 | enc[3]   | key[0] | enc[3] ^= key[0] |
| 1 | enc[4]   | key[1] | enc[4] ^= key[1] |
| 2 | enc[5]   | key[2] | enc[5] ^= key[2] |
| 3 | enc[6]   | key[3] | enc[6] ^= key[3] |
| 4 | enc[7]   | key[4] | enc[7] ^= key[4] |
| 5 | enc[8]   | key[5] | enc[8] ^= key[5] |
| 6 | enc[9]   | key[6] | enc[9] ^= key[6] |
| 7 | enc[10]  | key[7] | enc[10] ^= key[7] |

---

### *i = 4**

| j | enc[i+j] | key[j] | Operation |
|---|----------|--------|-----------|
| 0 | enc[4]   | key[0] | enc[4] ^= key[0] |
| 1 | enc[5]   | key[1] | enc[5] ^= key[1] |
| 2 | enc[6]   | key[2] | enc[6] ^= key[2] |
| 3 | enc[7]   | key[3] | enc[7] ^= key[3] |
| 4 | enc[8]   | key[4] | enc[8] ^= key[4] |
| 5 | enc[9]   | key[5] | enc[9] ^= key[5] |
| 6 | enc[10]  | key[6] | enc[10] ^= key[6] |
| 7 | enc[11]  | key[7] | enc[11] ^= key[7] |

---

### **i = 5**

| j | enc[i+j] | key[j] | Operation |
|---|----------|--------|-----------|
| 0 | enc[5]   | key[0] | enc[5] ^= key[0] |
| 1 | enc[6]   | key[1] | enc[6] ^= key[1] |
| 2 | enc[7]   | key[2] | enc[7] ^= key[2] |
| 3 | enc[8]   | key[3] | enc[8] ^= key[3] |
| 4 | enc[9]   | key[4] | enc[9] ^= key[4] |
| 5 | enc[10]  | key[5] | enc[10] ^= key[5] |
| 6 | enc[11]  | key[6] | enc[11] ^= key[6] |
| 7 | enc[12]  | key[7] | enc[12] ^= key[7] |

- This challenge seemed impossible to solve as there were 8 unknown key bytes
- But after some research on the PNG file format, I found out that the first eight bytes of a PNG are always constant
- This makes things much simpler as those 8 bytes can be found using these 8 fixed bytes in every PNG file
- I just need to reverse the ```rotate()``` and ```encrypt()``` functions
- After finding all the 8 bytes of the key, I can use XOR again (since the inverse of XOR is XOR itself) to find the original bytes of the PNG and reconstruct the image
- I created the following script to perform the above mentioned tasks:

```python
from pathlib import Path

d = Path("quote.png.enc").read_bytes()

def rotr(b,i):
    i%=8
    return ((b>>i)|((b<<(8-i))&0xff))&0xff

def rotl(b,i):
    i%=8
    return (((b<<i)&0xff)|(b>>(8-i)))&0xff

png = [0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a]
r = [rotr(png[i],i) for i in range(8)]
s = [d[i]^r[i] for i in range(8)]

key = [0]*8
key[0]=s[0]
for i in range(1,8):
    key[i]=s[i]^s[i-1]

arr = bytearray(d)
n=len(arr)
for i in range(n-8,-1,-1):
    for j in range(8):
        arr[i+j]^=key[j]

o = bytearray(n)
for i,b in enumerate(arr):
    o[i]=rotl(b,i)

Path("quote.png").write_bytes(o)
```

- This script:

1) Reads the bytes from ```quote.png.enc``` and stores them in a variable called d
2) It stores the known first 8 bytes of every PNG file in an array called ```png```
3) It rotates these known bytes in the same way as the encrypting script did
4) It XOR's the rotated known bytes and the encrypted bytes to find the key bytes
5) It reverses the XOR operations performed on all the other bytes in the PNG file for encoding
6) It reverses the rotation performed on each byte of the original PNG file
7) It writes the output into a file named ```quote.png```

- Opening this PNG image gives us the flag:

![```Quote.png``` is attached here](assets/Quixorte/quote.png)

- The flag is: ```nite{to_be_xor_not_to_be}```

## Flag

```
nite{to_be_xor_not_to_be}
```

## Concepts learnt

- Learnt the basics of the PNG file format
- Learnt how bit rotation works and how to reverse it
- Learnt how to analyze and deconstruct complex XOR operations

## Notes

- Nil

## Resources

- [PNG (Portable Network Graphics) Specification, Version 1.2](https://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html)
- [Python3 Program to Rotate bits of a number](https://www.geeksforgeeks.org/python/python3-program-to-rotate-bits-of-a-number/)


# 4. Willy's Chocolate Experience

> This challenge contains a single file named ```experience.py```

## Solution

- I opened up the file in Visual Studio Code to analyse the python code

```python
from Crypto.Util.number import *

# oompa loompa magic
def imagination_lab(m:int) -> int:
    p = 396430433566694153228963024068183195900644000015629930982017434859080008533624204265038366113052353086248115602503012179807206251960510130759852727353283868788493357310003786807
    return (pow(13, m, p) + pow(37, m, p)) % p

enchantment = b"nite{REDACTED}" # capture the enchantment
ticket = bytes_to_long(enchantment)

enchanted_candy = imagination_lab(ticket) # your ticket is now being made into a candy
candy_bag = []

# oompa loompa at work
for i in range(ticket):
    candy_bag.append(imagination_lab(i))

# find the ticket at the end
candy_bag.append(enchanted_candy)

# someone stole a few candies
leftover = candy_bag[-2:]

# can you get back your ticket?
print(leftover)

#[124499652441066069321544812234595327614165778598236394255418354986873240978090206863399216810942232360879573073405796848165530765886142184827326462551698684564407582751560255175, 208271276785711416565270003674719254652567820785459096303084135643866107254120926647956533028404502637100461134874329585833364948354858925270600245218260166855547105655294503224]
```

- I figured out that the code does the following things:

1) The program turns the flag into a number which is stored in the variable ```enchantment```
2) The function ```bytes_to_long()``` converts these bytes into one very large integer called the ticket

```python
enchantment = b"nite{REDACTED}" # capture the enchantment
ticket = bytes_to_long(enchantment)
```

3) The function ```imagination_lab()``` calculates:

```lua
13^m + 37^m (mod p)
```

where m is the number passed to the function

4) The program stores ```imagination_lab(ticket)``` in a variable called ```enchanted candy```
5) It then creates an array called ```candy_bag``` in which it stores ```imagination_lab(i)``` where ```i``` ranges from 0 to ```ticket - 1```
6) The program appends ```enchanged_candy``` at the end of ```candy_bag```
7) After that, the program removes everything from the array except the last two values

```python
# someone stole a few candies
leftover = candy_bag[-2:]
```

8) This leaves only ```imagination_lab(ticket - 1)``` and ```imagination_lab(ticket)``` left in the array
9) The program then prints the contents of ```candy_bag```

```text
[124499652441066069321544812234595327614165778598236394255418354986873240978090206863399216810942232360879573073405796848165530765886142184827326462551698684564407582751560255175, 208271276785711416565270003674719254652567820785459096303084135643866107254120926647956533028404502637100461134874329585833364948354858925270600245218260166855547105655294503224]
```

- Let ```a = 13```, ```b = 37```, and ```imagination_lab(m) be equivalent to a mathematical function f(m)```
- Therefore, ```f(m) = (a^m + b^m) mod p```
- We have ```f(n-1)``` and ```f(n)``` where ```n = ticket```
- Let ```x = 13^n mod p``` and ```y = 37^n mod p```
- Then:

```
S(n)   = x + y
S(n-1) = x/13 + y/37   (all mod p)
```

- We can use the above two values to calculate ```13^n mod p```
- We can multiply the second equation by ```13 * 37```, which gives:

```
13*37 * S(n-1) = 37*x + 13*y
```

- Now we have:

```
x + y = S(n)
37*x + 13*y = 13*37*S(n-1)
```

- This gives us two equations and two unknowns
- We can solve these equations to obtain ```x = 13^n mod p```
- Now we can solve this simple log problem ```13^n ≡ x (mod p)``` and get the value of ```n```
- We can then convert this n to the bytes and obtain the flag from those bytes

- The following is the python script to perform the above mentioned actions:

```python
p = 96430433566694153228963024068183195900644000015629930982017434859080008533624204265038366113052353086248115602503012179807206251960510130759852727353283868788493357310003786807
S_prev = 124499652441066069321544812234595327614165778598236394255418354986873240978090206863399216810942232360879573073405796848165530765886142184827326462551698684564407582751560255175
S_now  = 208271276785711416565270003674719254652567820785459096303084135643866107254120926647956533028404502637100461134874329585833364948354858925270600245218260166855547105655294503224
a = 13
b = 37
inv = pow(a - b, -1, p)
x = ((a * S_now - a * b * S_prev) % p) * inv % p
print(x)
```

- The following is the output produced by the script:

```text
c:\Users\Neelay\Desktop\Miscellaneous\Cryptonite\Curated Challenges\Cryptography\assets\Quixorte>C:/Users/Neelay/AppData/Local/Programs/Python/Python314/python.exe "c:/Users/Neelay/Desktop/Miscellaneous/Cryptonite/Curated Challenges/Cryptography/assets/Willy's Chocolate Experience/willys_chocolate_experience_solve.py"
96162063603731572543107664261365158519330076110304444006175606270801860855235217836031584931965263551066286488775336210061924862378790019627917643146298490237717275857895812670
```
- This script:

1) It loads the numbers printed from the encryption algorithm
2) It defines ```a = 13``` and ```b = 37```
3) It computes the modular inverse of ```(a-b)```
4) It computes ```x = 13^n mod p```
5) It prints the computed value of ```x```

- I then found an online math solver to solve the discrete log problem (SageMath)
- I entered the following commands into SageMath to solve the problem and obtain the value of ```n```

![Image of the SageMath commands and output](assets/Willy's%20Chocolate%20Experience/sagemath_willys_chocolate_experience.png)

- The flag obtained: ```nite{g0ld3n_t1ck3t_t0_gl4sg0w}```
-
## Flag

```
nite{g0ld3n_t1ck3t_t0_gl4sg0w}
```

## Concepts learnt

- Learnt how to solve mathematical equations containing modulus
- Learnt how to use SageMath

## Notes

- Nil

## Resources

- [SageMath Tutorials](https://youtu.be/Cb2E0bznd-w?si=iEHukN_XFUitdLNv)
- [The Discrete Logarithm Problem (Solved Example)](https://www.youtube.com/watch?v=yKNTfeqSEhc)
- [SageMathCell](https://sagecell.sagemath.org/)


# 5. spAES Oddity

> This challenge contains five files named:

```text
1) chal.py
2) docker-compose.yml
3) DockerFile
4) README.md
5) secret.py
```

## Solution

- I opened up the ```chal.py``` file in VSC for inspection

```python
from Crypto.Util.Padding import *
from Crypto.Cipher import AES
from secret import FLAG, KEY

assert len(FLAG) == 49 # flag format = nite{[-_A-Da-z0-4]} (charset)

def encrypt(message):
    try:
        assert len(message) % 2 == 1
        cipher = AES.new(KEY, AES.MODE_ECB)
        c = cipher.encrypt(pad(message + FLAG, 16))
        return c.hex()
    except Exception:
        return "Major Tom [to Ground control]: The odds are NOT in your favour!"

def main():
    while True:
        print("-- Ground control to Major Tom --")
        m = input('input in hex:')
        e = encrypt(bytes.fromhex(m))
        print(e)

if __name__ == "__main__":
    main()
```

- The program runs an assertion that the flag length from ```secret.py``` has to be 49 or python will throw an ```AssertionError```
- This gives us an idea of the length and format of the flag
- Then, a function is created called ```encrypt()``` which:
    * Takes a message as its argument
    * asserts that the message must have an odd length otherwise it triggers an ```AssertionError```
    * Creates an AES cipher object in ECB mode with the key obtained from ```secret.py```
    * The line ```c = cipher.encrypt(pad(message + FLAG, 16))``` concatenates ```message``` and ```flag``` and pads it upto a length of 16 bytes and then encrypts this using AES-ECB
    * Then it returns the raw ciphertext as a lowercase hex string
- The ```main()``` function does the following:
    * It contains an infinite loop which makes the program prompt continuously for new input
    * ``` m = input('input in hex:')``` reads a line of text from the user
    * ``` e = encrypt(bytes.fromhex(m))``` converts the hex string into raw bytes before calling ```encrypt```
    * The result of ```encrypt(....)``` is printed
- The last statements run the interactive server when ```chal.py``` is executed as a script

- The goal is to find the 49 character flag
- ECB has a property which can be exploited: If two plaintext blocks are the same, their ciphertext blocks are the same.
- Therefore the strategy is to force the FLAG bytes into a predictable block position and then brute-force which character causes the ciphertext block to match
- The important observation is:

```
plaintext = message + FLAG
```

- If we send 15 bytes (an odd number), then:
    * The 16th byte of the plaintext becomes the first byte of the flag
    * The first ciphertext block now contains:

        ```css
        [our 15 bytes] + [FLAG[0]]
        ```

- Then we brute-force the first flag character by trying:

```python
15 × 'A' + guess + 15 dummy bytes
```

- Every guess produces a ciphertext
- If the first block matches the reference block, then the guess is correct
- This gives us ```FLAG[0]```

- After the first byte, recovering one byte at a time becomes messy because of the “odd length” requirement
- The solution is to recover two characters per step, which makes it easier to keep payload length valid
- We know some prefix of the flag already
- Compute how many padding bytes are needed so that ```[padding] + [known_flag] + [next two flag bytes]``` ends exactly on a block boundary.
- Try every pair ```(c1, c2)``` from the allowed character set, building payloads of the form

```css
padding + known_flag + c1 + c2 + dummy bytes
```

- Encrypt each payload and compare the target block to the reference block
- When they match, we have discovered two new flag characters
- This process repeats until all 49 characters are recovered

- The following is the python script written to exploit this vulnerability:

```python
from pwn import remote
from Crypto.Util.Padding import pad
import string

HOST = "spaesoddity.nitephase.live"
PORT = 45673

CHARSET = string.ascii_lowercase + string.digits + "-_ABCD{}"

def connect():
    return remote(HOST, PORT)

def query(conn, payload: bytes):
    conn.recvuntil(b"input in hex:")
    conn.sendline(payload.hex().encode())
    out = conn.recvline().strip().decode()
    if "Major Tom" in out:
        return None
    return out

def recover_first_byte(conn):
    filler = b"A" * 15
    baseline = query(conn, filler)
    target = baseline[:32]

    for ch in CHARSET:
        attempt = filler + ch.encode() + b"A" * 15
        ct = query(conn, attempt)
        if ct and ct[:32] == target:
            print(f"[+] First byte: {ch}")
            return ch

    raise ValueError("Could not determine first byte")

def locate_block(position):
    target_len = position + 2
    pad_len = (16 - (target_len % 16)) % 16
    block_index = (pad_len + target_len) // 16 - 1
    return pad_len, block_index

def recover_flag():
    conn = connect()
    flag = recover_first_byte(conn)

    while len(flag) < 49:
        pos = len(flag)
        pad_len, blk = locate_block(pos)
        pad_bytes = b"A" * pad_len

        probe = query(conn, pad_bytes)
        start, end = blk * 32, blk * 32 + 32
        reference = probe[start:end]

        print(f"[*] Recovering bytes {pos} & {pos+1} | pad={pad_len} | block={blk}")

        found = False

        for c1 in CHARSET:
            for c2 in CHARSET:
                candidate = pad_bytes + (flag + c1 + c2).encode() + b"A" * 15
                ct = query(conn, candidate)
                if ct and ct[start:end] == reference:
                    flag += c1 + c2
                    found = True
                    print(f"[+] Current flag → {flag}")
                    break
            if found:
                break

        if not found:
            print("[-] No matching pair found — aborting.")
            break

    conn.close()
    return flag

if __name__ == "__main__":
    final_flag = recover_flag()
    print("\n[SUCCESS] FLAG:", final_flag)
```

- The script uses ```pwntools``` to open a remote connection to the AES-ECB oracle
- It sends 15 bytes to force the first flag byte into the end of the first AES block
- It then brute-forces which character, when appended, produces the same ciphertext block
- For each step:
    * It calculates how many padding bytes are needed to align the next two unknown flag bytes at the end of a block
    * It sends this padding alone to get the reference ciphertext block
    * It tries every possible character pair ```(c1, c2)``` from the flag's charset
    * For each pair, it constructs a payload that positions these guessed bytes exactly where the real flag bytes would appear
    * When the ciphertext block matches the reference block, those two characters are correct
- The above process repeats until all 49 characters are recovered

- Running the script eventually reconstructs the flag:

```
nite{D4v1d_B0w13-s_0dds_w3r3_n3v3r_1n_y0ur_f4v0r}
```

![A screenshot of the output obtained after letting the above python exploit script run and finish](assets/spAES%20Oddity/spaes_oddity_exploit_output.png)

## Flag

```
nite{D4v1d_B0w13-s_0dds_w3r3_n3v3r_1n_y0ur_f4v0r}
```

## Concepts learnt

- Learnt how AES-ECB encryption works and what are some of its weaknesses
- Learnt that by controlling input length, and alignment, secret appended data can be brute-forced block by block

## Notes

- Nil

## Resources

- [Electronic Code Book (ECB) in Cryptography](https://www.geeksforgeeks.org/computer-networks/electronic-code-book-ecb-in-cryptography/)
- ChatGPT
